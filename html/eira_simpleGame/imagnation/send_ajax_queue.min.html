<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>发送ajax请求——队列处理</title>
		<script type="text/javascript" src="../js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="../js/skill_extension.js"></script>
	</head>

	<body>

		<button class="sendRequest">发送请求</button>
		<button class="run">开始发起请求</button>

	</body>

	<script type="text/javascript">
		function generateRandStr_Time() {
			return new Date().format("hh_mm_ss");
		}

		var SendAjaxQueue = {

			sendSuccess: true, //当前请求是否已完成
			ajaxList: new Array(), //ajax队列
			pushItem: function(item, dealFunc) {
				var item = this.buildItem(item, dealFunc);
				this.ajaxList.push(item);
				console.log("追加请求："+item.ParamInfo);
				console.log(this.ajaxList);
			},
			buildItem: function(item, dealFunc) {

				return {
					ParamInfo: item,
					DealFunc: dealFunc,
					FlagNo: generateRandStr_Time()
				};
			},
//			removeItem: function(item) {
//				//删除方法有毒
//				this.ajaxList.pop();
//				var index = $.inArray(item, this.ajaxList); //查找元素位置
//				this.ajaxList.baoremove(index);
//			},
			run: function() {
				var item = this.ajaxList[0];

				if(this.sendSuccess) {

						this.sendSuccess = false;
					setTimeout(function() {
						item.DealFunc(item.ParamInfo); 
						SendAjaxQueue.removeItem(item);
						console.log(item.FlagNo + "》》请求完成");
//						this.sendSuccess = true; 
						SendAjaxQueue.removeItem(item);
						SendAjaxQueue.sendSuccess = true; 
						if(SendAjaxQueue.ajaxList && SendAjaxQueue.ajaxList.length > 0) { 
							SendAjaxQueue.run();
						}
					}, 1000); 
				} else {
					console.log(item)
					console.log("继续等待.....");
				}

			}

		};

		SendAjaxQueue.removeItem("test");

		var i = 0;

		$(".sendRequest").click(function() {
			i++;
			SendAjaxQueue.pushItem("请求i:" + i, function(data) {
				console.log("回调处理：" + data);
			});
			//不稳定
//			SendAjaxQueue.run(); //方法内部有处理验证，故可以在追加后立即调用此方法
		});
		
		$(".run").click(function(){
			SendAjaxQueue.run();
		});
		
//		setInterval(function(){
////			console.log(SendAjaxQueue.sendSuccess);
//		},1000);
		
	</script>

</html>